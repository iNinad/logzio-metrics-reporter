pipeline {
    agent {
        docker {
            image 'python:3.10-slim'
            args '-v /tmp:/tmp --user root'
        }
    }
    environment {
        NA_TOKEN = credentials('Logzio_NA01_Token_SearchAPI') // Securely fetch NA token
        EU_TOKEN = credentials('Logzio_EU01_Token_SearchAPI') // Securely fetch EU token
    }
    parameters {
        choice(name: 'PLATFORM', choices: ['production', 'staging'], description: 'Select the platform for querying and collecting metrics.')
        string(name: 'DATE', defaultValue: "${java.time.LocalDate.now().minusDays(8)}", description: 'Enter the base date (YYYY-MM-DD)')
        string(name: 'START_TIME', defaultValue: '08:00:00Z', description: 'Enter the start time (HH:mm:ssZ)')
        string(name: 'END_TIME', defaultValue: '10:00:00Z', description: 'Enter the end time (HH:mm:ssZ)')
        string(name: 'TIME_RANGE', defaultValue: '8', description: 'Number of days before and after the base date')
        string(name: 'CONFLUENCE_PAGE', defaultValue: 'Logz.io Metrics', description: 'Enter the Confluence page name')
        booleanParam(name: 'CHECKOUT_OAS_DEPLOYMENT', defaultValue: false, description: 'Select to checkout oas-deployment repository for customers.yml')
    }
    stages {
        stage('Checkout Current Repository') {
            steps {
                echo '[INFO] Checking out repository containing script.py...'
                checkout scm
            }
        }
        stage('Optional Checkout oas-deployment Repository') {
            when {
                expression { params.CHECKOUT_OAS_DEPLOYMENT }
            }
            steps {
                echo '[INFO] Checking out oas-deployment repository for customers.yml...'
                dir('oas-deployment') {
                    checkout([$class: 'GitSCM',
                        branches: [[name: '*/eu01-prd']], // Replace 'eu01-prd' with the appropriate branch if different
                        extensions: [
                            [$class: 'SparseCheckoutPaths', paths: ['customers.yml']] // Sparse checkout for just `customers.yml`
                        ],
                        userRemoteConfigs: [[url: 'git@git.cias.one:tid/oas-deployment',
                        credentialsId: 'ciasGitCredentialIdentifier',]]
                    ])
                }
            }
        }
        stage('Setup Python Environment') {
            steps {
                echo '[INFO] Setting up Python environment...'
                sh '''
                pip install --no-cache-dir -r requirements.txt
                '''
            }
        }
        stage('Run Script') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'CONFLUENCE_IMPORTER', usernameVariable: 'confluenceUser', passwordVariable: 'confluencePassword')]) {
                        def platformValue = params.PLATFORM == 'production' ? 'prd' : 'stg'
                        def customersFile = params.CHECKOUT_OAS_DEPLOYMENT ? 'oas-deployment/customers.yml' : 'customers.yml'
                        echo '[INFO] Running Python script...'
                        sh """
                        python logz_metrics_handler.py \
                            --platform "${platformValue}" \
                            --date ${DATE} \
                            --start_time ${START_TIME} \
                            --end_time ${END_TIME} \
                            --time_range ${TIME_RANGE} \
                            --eu_token "$EU_TOKEN" \
                            --na_token "$NA_TOKEN" \
                            --customers_file "${customersFile}" \
                            --page_title "${CONFLUENCE_PAGE}" \
                            --confluence_username "${confluenceUser}" \
                            --confluence_api_token "${confluencePassword}"
                        """
                    }
                }
            }
        }
        stage('Archive Results') {
            steps {
                echo '[INFO] Archiving output.csv as a build artifact...'
                archiveArtifacts artifacts: 'output.csv', fingerprint: true
            }
        }
    }
    post {
        always {
            echo '[INFO] Cleaning up workspace...'
            cleanWs()
        }
        success {
            echo '[SUCCESS] Pipeline completed successfully!'
        }
        failure {
            echo '[ERROR] Pipeline failed!'
        }
    }
}
